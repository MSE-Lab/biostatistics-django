{% extends 'simulators/base.html' %}
{% load static %}

{% block title %}置信区间计算器{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/simulators.css' %}">
<!-- 确保Bootstrap正常加载 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
    .simulator-container {
        max-width: 100%;
        padding: 15px;
        min-height: 100vh;
    }
    
    .calculator-panel {
        background: white;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border: 2px solid #007bff;
    }
    
    .result-panel {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 20px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #28a745;
    }
    
    .theory-panel {
        background: #e3f2fd;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-left: 5px solid #2196f3;
    }
    
    .input-step {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 15px;
        border-left: 4px solid #007bff;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .step-number {
        display: inline-block;
        background: #007bff;
        color: white;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        text-align: center;
        line-height: 30px;
        font-weight: bold;
        margin-right: 10px;
    }
    
    .btn-calculate {
        background: linear-gradient(135deg, #007bff, #0056b3);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 5px;
    }
    
    .btn-calculate:hover {
        background: linear-gradient(135deg, #0056b3, #007bff);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        color: white;
    }
    
    .btn-reset {
        background: linear-gradient(135deg, #6c757d, #495057);
        border: none;
        color: white;
        padding: 12px 30px;
        border-radius: 25px;
        font-weight: 600;
        transition: all 0.3s ease;
        margin: 5px;
    }
    
    .btn-reset:hover {
        background: linear-gradient(135deg, #495057, #6c757d);
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(108, 117, 125, 0.3);
        color: white;
    }
    
    .formula-display {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
        font-family: 'Times New Roman', serif;
        border: 1px solid #dee2e6;
        text-align: center;
    }
    
    .result-highlight {
        background: linear-gradient(135deg, #d4edda, #c3e6cb);
        border-radius: 10px;
        padding: 20px;
        margin: 15px 0;
        border: 2px solid #28a745;
        text-align: center;
    }
    
    .parameter-slider {
        width: 100% !important;
        margin: 10px 0;
        height: 6px;
        background: #ddd;
        border-radius: 3px;
        outline: none;
        -webkit-appearance: none;
        appearance: none;
    }
    
    .parameter-slider::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .parameter-slider::-moz-range-thumb {
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #007bff;
        cursor: pointer;
        border: 2px solid #fff;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .parameter-slider::-webkit-slider-track {
        width: 100%;
        height: 6px;
        cursor: pointer;
        background: #ddd;
        border-radius: 3px;
    }
    
    .parameter-slider::-moz-range-track {
        width: 100%;
        height: 6px;
        cursor: pointer;
        background: #ddd;
        border-radius: 3px;
        border: none;
    }
    
    .distribution-canvas {
        width: 100%;
        height: 300px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        margin: 15px 0;
    }
    
    .confidence-bar {
        height: 30px;
        background: linear-gradient(90deg, #dc3545, #ffc107, #28a745);
        border-radius: 15px;
        margin: 10px 0;
        position: relative;
        overflow: hidden;
    }
    
    .confidence-marker {
        position: absolute;
        top: 0;
        height: 100%;
        width: 3px;
        background: #000;
        transition: left 0.3s ease;
    }
    
    .interval-display {
        font-size: 1.5rem;
        font-weight: bold;
        color: #007bff;
        text-align: center;
        margin: 20px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
        border: 2px dashed #007bff;
    }
    
    .critical-value-display {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        border-radius: 8px;
        padding: 15px;
        margin: 10px 0;
    }
    
    .scenario-card {
        background: white;
        border-radius: 10px;
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: all 0.3s ease;
    }
    
    .scenario-card:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transform: translateY(-2px);
    }
    
    .scenario-card.active {
        border-color: #007bff;
        background: #f8f9fa;
    }
    
    /* 确保Bootstrap网格系统正常工作 */
    .row {
        display: flex;
        flex-wrap: wrap;
        margin-right: -15px;
        margin-left: -15px;
    }
    
    .col-md-6 {
        position: relative;
        width: 100%;
        padding-right: 15px;
        padding-left: 15px;
    }
    
    @media (min-width: 768px) {
        .col-md-6 {
            flex: 0 0 50%;
            max-width: 50%;
        }
    }
    
    @media (max-width: 768px) {
        .calculator-panel {
            padding: 15px;
        }
        
        .interval-display {
            font-size: 1.2rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="simulator-container">
    <div class="row">
        <div class="col-12">
            <h2 class="text-center mb-4" style="color: #007bff; font-weight: bold;">
                <i class="fas fa-calculator me-2"></i>
                置信区间计算器
                <i class="fas fa-chart-line ms-2"></i>
            </h2>
        </div>
    </div>
    
    <!-- 参数输入和理论说明 -->
    <div class="row">
        <div class="col-md-6">
            <div class="theory-panel">
                <h5 class="mb-4" style="color: #2196f3;">
                    <i class="fas fa-book me-2"></i>理论基础
                </h5>
                
                <div class="mb-3">
                    <h6 style="color: #2196f3;">
                        <i class="fas fa-formula me-2"></i>置信区间公式
                    </h6>
                    <div class="formula-display">
                        <div style="font-size: 1.2rem;">
                            <strong>CI = x̄ ± z<sub>α/2</sub> × (σ/√n)</strong>
                        </div>
                        <div class="mt-2 small text-muted">
                            其中：z<sub>α/2</sub> 是标准正态分布的临界值
                        </div>
                    </div>
                </div>
                
                <div class="mb-3">
                    <h6 style="color: #2196f3;">
                        <i class="fas fa-info-circle me-2"></i>置信区间含义
                    </h6>
                    <p class="small">
                        95%置信区间意味着：如果我们重复进行相同的抽样过程很多次，
                        大约95%的置信区间会包含真实的总体均值μ。
                    </p>
                </div>
                
                <div class="mb-3">
                    <h6 style="color: #2196f3;">
                        <i class="fas fa-lightbulb me-2"></i>影响因素
                    </h6>
                    <ul class="small">
                        <li><strong>置信水平↑</strong> → 区间宽度↑</li>
                        <li><strong>样本量↑</strong> → 区间宽度↓</li>
                        <li><strong>总体标准差↑</strong> → 区间宽度↑</li>
                    </ul>
                </div>
                
                <div class="alert alert-info">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    <small>
                        <strong>注意：</strong>本计算器适用于总体方差已知的情况，
                        使用标准正态分布的临界值。
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="calculator-panel">
                <h5 class="mb-4">
                    <i class="fas fa-cogs me-2 text-primary"></i>参数设置
                </h5>

                <div class="input-step">
                    <span class="step-number">1</span>
                    <strong>总体标准差 (σ)</strong>
                    <div class="mt-2">
                        <input type="number" class="form-control" id="populationStd" value="10" step="0.01" min="0.01" placeholder="输入总体标准差">
                        <small class="text-muted">总体的标准差（已知）</small>
                    </div>
                </div>
                
                <div class="input-step">
                    <span class="step-number">2</span>
                    <strong>样本均值 (x̄)</strong>
                    <div class="mt-2">
                        <input type="number" class="form-control" id="sampleMean" value="50" step="0.01" placeholder="输入样本均值">
                        <small class="text-muted">样本观测值的平均数</small>
                    </div>
                </div>
                
                <div class="input-step">
                    <span class="step-number">3</span>
                    <strong>样本量 (n)</strong>
                    <div class="mt-2">
                        <input type="number" class="form-control" id="sampleSize" value="25" min="1" placeholder="输入样本量">
                        <small class="text-muted">样本中观测值的个数</small>
                    </div>
                </div>
                
                <div class="input-step">
                    <span class="step-number">4</span>
                    <strong>置信水平</strong>
                    <div class="mt-2">
                        <select class="form-select" id="confidenceLevel">
                            <option value="90">90% (α = 0.10)</option>
                            <option value="95" selected>95% (α = 0.05)</option>
                            <option value="99">99% (α = 0.01)</option>
                            <option value="custom">自定义</option>
                        </select>
                        <div id="customConfidenceDiv" style="display: none;" class="mt-2">
                            <input type="number" class="form-control" id="customConfidence" min="50" max="99.99" step="0.01" placeholder="输入置信水平 (50-99.99)">
                        </div>
                        <small class="text-muted">置信区间的可信程度</small>
                    </div>
                </div>
                
                <div class="text-center mt-4">
                    <button class="btn btn-calculate btn-lg" id="calculateBtn">
                        <i class="fas fa-calculator me-2"></i>计算置信区间
                    </button>
                    <button class="btn btn-reset btn-lg" id="resetBtn">
                        <i class="fas fa-redo me-2"></i>重置参数
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 计算结果 -->
    <div id="resultsArea" style="display: none;">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
            <!-- 左侧：计算结果 -->
            <div>
                <div class="result-panel">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-bar me-2 text-success"></i>计算结果
                    </h5>
                    
                    <div class="interval-display" id="intervalResult">
                        <!-- 置信区间结果将在这里显示 -->
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; text-align: center; margin-bottom: 15px;">
                        <div class="border rounded p-3">
                            <div class="h5 text-primary" id="lowerBound">--</div>
                            <small>下限</small>
                        </div>
                        <div class="border rounded p-3">
                            <div class="h5 text-success" id="marginError">--</div>
                            <small>误差边际</small>
                        </div>
                        <div class="border rounded p-3">
                            <div class="h5 text-primary" id="upperBound">--</div>
                            <small>上限</small>
                        </div>
                    </div>
                    
                    <div class="critical-value-display">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                            <div>
                                <strong>临界值 (z<sub>α/2</sub>):</strong>
                                <span id="criticalValue" class="text-primary">--</span>
                            </div>
                            <div>
                                <strong>标准误差:</strong>
                                <span id="standardError" class="text-info">--</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6>计算步骤</h6>
                        <div id="calculationSteps" class="small">
                            <!-- 计算步骤将在这里显示 -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 右侧：可视化 -->
            <div>
                <div class="result-panel">
                    <h5 class="mb-3">
                        <i class="fas fa-chart-line me-2 text-info"></i>可视化
                    </h5>
                    
                    <canvas id="distributionChart" class="distribution-canvas"></canvas>
                    
                    <div class="mt-3">
                        <h6>参数敏感性分析</h6>
                        <div class="mb-2">
                            <label class="form-label small">调整样本量: <span id="nSliderValue">25</span></label>
                            <input type="range" class="parameter-slider" id="nSlider" min="5" max="100" value="25">
                        </div>
                        <div class="mb-2">
                            <label class="form-label small">调整置信水平: <span id="clSliderValue">95</span>%</label>
                            <input type="range" class="parameter-slider" id="clSlider" min="80" max="99" value="95">
                        </div>
                        <div class="small text-muted">
                            <strong>当前区间宽度:</strong> <span id="intervalWidth">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
</div>
{% endblock %}

{% block extra_js %}
<!-- 确保Bootstrap JS正常加载 -->
<script src="{% static 'vendor/bootstrap/bootstrap.bundle.js' %}"></script>
<script src="{% static 'js/confidence_interval.js' %}"></script>
<script src="{% static 'vendor/chartjs/chart.js' %}"></script>
{% endblock %}