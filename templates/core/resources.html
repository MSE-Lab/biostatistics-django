{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - 生物统计学课程平台{% endblock %}

{% block content %}
<!-- 页面标题 -->
<section class="page-header">
    <div class="container">
        <h1 class="page-title">学习资源</h1>
        <p class="page-subtitle">精选视频教程，助力生物统计学学习</p>
    </div>
</section>

<div class="resources-container">

    <!-- 推荐视频 -->
    {% if featured_videos %}
    <div class="featured-section">
        <h2 class="section-title">推荐视频</h2>
        <div class="featured-videos">
            {% for video in featured_videos %}
            <div class="featured-video-card" data-video-id="{{ video.id }}">
                <div class="video-thumbnail">
                    {% if video.thumbnail %}
                        <img src="{{ video.thumbnail.url }}" alt="{{ video.title }}">
                    {% else %}
                        <div class="default-thumbnail">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                            </svg>
                        </div>
                    {% endif %}
                    <div class="play-overlay">
                        <div class="play-button">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                            </svg>
                        </div>
                    </div>
                    {% if video.duration %}
                    <div class="duration">{{ video.duration }}</div>
                    {% endif %}
                </div>
                <div class="video-info">
                    <h3 class="video-title">{{ video.title }}</h3>
                    <p class="video-description">{{ video.description|truncatechars:100 }}</p>
                    <div class="video-meta">
                        <span class="category">{{ video.get_category_display }}</span>
                        <span class="views">{{ video.view_count }} 次观看</span>
                        <span class="date">{{ video.created_at|date:"Y-m-d" }}</span>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- 所有视频 -->
    <div class="all-videos-section">
        <div class="section-header">
            <div class="filter-tabs">
                <button class="filter-tab active" data-category="all">全部</button>
                {% for category_code, category_name in categories %}
                <button class="filter-tab" data-category="{{ category_code }}">{{ category_name }}</button>
                {% endfor %}
            </div>
        </div>
        
        <div class="videos-grid" id="videos-grid">
            {% for video in all_videos %}
            <div class="video-card" data-video-id="{{ video.id }}" data-category="{{ video.category }}">
                <div class="video-thumbnail">
                    {% if video.thumbnail %}
                        <img src="{{ video.thumbnail.url }}" alt="{{ video.title }}">
                    {% else %}
                        <div class="default-thumbnail">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                            </svg>
                        </div>
                    {% endif %}
                    <div class="play-overlay">
                        <div class="play-button">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                            </svg>
                        </div>
                    </div>
                    {% if video.duration %}
                    <div class="duration">{{ video.duration }}</div>
                    {% endif %}
                </div>
                <div class="video-info">
                    <h3 class="video-title">{{ video.title }}</h3>
                    <p class="video-description">{{ video.description|truncatechars:80 }}</p>
                    <div class="video-meta">
                        <span class="category">{{ video.get_category_display }}</span>
                        <span class="views">{{ video.view_count }} 次观看</span>
                    </div>
                    <div class="video-actions">
                        <!-- <button class="btn-play" onclick="playVideo('{{ video.id }}', '{{ video.video_url }}', '{{ video.title }}')">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M8 5V19L19 12L8 5Z" fill="currentColor"/>
                            </svg>
                            播放
                        </button> -->
                        <a href="{{ video.video_url }}" target="_blank" class="btn-external">
                            <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M18 13V19C18 19.5304 17.7893 20.0391 17.4142 20.4142C17.0391 20.7893 16.5304 21 16 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V8C3 7.46957 3.21071 6.96086 3.58579 6.58579C3.96086 6.21071 4.46957 6 5 6H11" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M15 3H21V9" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M10 14L21 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            点击播放
                        </a>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class="empty-state">
                <div class="empty-icon">
                    <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M23 7L16 12L23 17V7Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <rect x="1" y="5" width="15" height="14" rx="2" ry="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3>暂无视频资源</h3>
                <p>管理员正在努力添加更多学习资源，敬请期待！</p>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- 视频播放模态框 -->
<div class="video-modal" id="videoModal">
    <div class="modal-overlay" onclick="closeVideoModal()"></div>
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title" id="modalTitle">视频播放</h3>
            <button class="modal-close" onclick="closeVideoModal()">
                <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M18 6L6 18M6 6L18 18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
        </div>
        <div class="modal-body">
            <div class="video-container" id="videoContainer">
                <!-- 视频内容将在这里动态加载 -->
            </div>
        </div>
    </div>
</div>

<script>
// 分类筛选功能
document.addEventListener('DOMContentLoaded', function() {
    const filterTabs = document.querySelectorAll('.filter-tab');
    const videoCards = document.querySelectorAll('.video-card');
    
    filterTabs.forEach(tab => {
        tab.addEventListener('click', function() {
            const category = this.dataset.category;
            
            // 更新活跃标签
            filterTabs.forEach(t => t.classList.remove('active'));
            this.classList.add('active');
            
            // 筛选视频
            videoCards.forEach(card => {
                if (category === 'all' || card.dataset.category === category) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        });
    });
});

// 转换视频URL为嵌入格式
function convertToEmbedUrl(videoUrl) {
    let embedUrl = videoUrl;
    
    // YouTube处理
    if (videoUrl.includes('youtube.com/watch')) {
        const videoId = videoUrl.split('v=')[1];
        if (videoId) {
            const cleanId = videoId.split('&')[0];
            embedUrl = `https://www.youtube.com/embed/${cleanId}?autoplay=1&rel=0`;
        }
    } 
    // YouTube短链接处理
    else if (videoUrl.includes('youtu.be/')) {
        const videoId = videoUrl.split('youtu.be/')[1];
        if (videoId) {
            const cleanId = videoId.split('?')[0];
            embedUrl = `https://www.youtube.com/embed/${cleanId}?autoplay=1&rel=0`;
        }
    }
    // B站处理
    else if (videoUrl.includes('bilibili.com/video')) {
        const bvMatch = videoUrl.match(/BV[a-zA-Z0-9]+/);
        if (bvMatch) {
            embedUrl = `https://player.bilibili.com/player.html?bvid=${bvMatch[0]}&page=1&autoplay=1`;
        }
    }
    // 腾讯视频处理
    else if (videoUrl.includes('v.qq.com')) {
        const vidMatch = videoUrl.match(/\/([a-zA-Z0-9]+)\.html/);
        if (vidMatch) {
            embedUrl = `https://v.qq.com/txp/iframe/player.html?vid=${vidMatch[1]}&autoplay=1`;
        }
    }
    // 如果已经是嵌入链接，直接使用
    else if (videoUrl.includes('embed') || videoUrl.includes('player')) {
        embedUrl = videoUrl;
    }
    
    return embedUrl;
}

// 视频播放功能
function playVideo(videoId, videoUrl, title) {
    const modal = document.getElementById('videoModal');
    const modalTitle = document.getElementById('modalTitle');
    const videoContainer = document.getElementById('videoContainer');
    
    modalTitle.textContent = title;
    
    // 转换为嵌入URL
    const embedUrl = convertToEmbedUrl(videoUrl);
    
    console.log('原始URL:', videoUrl);
    console.log('嵌入URL:', embedUrl);
    
    if (embedUrl && embedUrl !== videoUrl) {
        // 创建iframe用于嵌入播放
        videoContainer.innerHTML = `
            <iframe 
                src="${embedUrl}" 
                width="100%" 
                height="100%" 
                frameborder="0" 
                allowfullscreen 
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                sandbox="allow-same-origin allow-scripts allow-popups allow-forms"
            ></iframe>
        `;
    } else {
        // 如果无法转换为嵌入格式，显示提示信息
        videoContainer.innerHTML = `
            <div style="color: white; text-align: center; padding: 40px;">
                <p style="margin-bottom: 20px;">此视频无法在模态框中播放</p>
                <p style="margin-bottom: 20px;">请点击"新窗口打开"按钮在新标签页中观看</p>
                <button onclick="window.open('${videoUrl}', '_blank')" style="background: #007aff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer;">
                    在新窗口打开
                </button>
            </div>
        `;
    }
    
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
    
    // 增加观看次数（可以通过AJAX实现）
    // incrementViewCount(videoId);
}

function closeVideoModal() {
    const modal = document.getElementById('videoModal');
    const videoContainer = document.getElementById('videoContainer');
    
    modal.classList.remove('show');
    document.body.style.overflow = '';
    
    // 延迟清空内容，让动画完成
    setTimeout(() => {
        videoContainer.innerHTML = '';
    }, 300);
}

// 模态框事件处理
document.addEventListener('DOMContentLoaded', function() {
    const modal = document.getElementById('videoModal');
    
    // 点击遮罩关闭模态框
    modal.addEventListener('click', function(e) {
        if (e.target === this || e.target.classList.contains('modal-overlay')) {
            closeVideoModal();
        }
    });
    
    // ESC键关闭模态框
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            const modal = document.getElementById('videoModal');
            if (modal.classList.contains('show')) {
                closeVideoModal();
            }
        }
    });
});
</script>
{% endblock %}