{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }} - ç”Ÿç‰©ç»Ÿè®¡å­¦è¯¾ç¨‹å¹³å°{% endblock %}

{% block content %}
<!-- é¡µé¢æ ‡é¢˜ -->
<section class="page-header">
    <div class="container">
        <h1 class="page-title">{{ title }}</h1>
        <p class="page-subtitle">ç³»ç»Ÿå­¦ä¹ ç”Ÿç‰©ç»Ÿè®¡å­¦çš„æ ¸å¿ƒçŸ¥è¯†</p>
    </div>
</section>

<!-- è¯¾ç¨‹åˆ—è¡¨ -->
<section class="courses-section">
    <div class="container">
        <div class="courses-grid">
            {% for course in courses %}
            <div class="course-card-compact" onclick="openCourseModal({{ course.id }})">
                <div class="course-card-header">
                    <div class="course-number-compact">{{ course.id }}</div>
                    <div class="course-card-content">
                        <h3 class="course-card-title">{{ course.title }}</h3>
                        <p class="course-card-description">{{ course.description }}</p>
                        <div class="course-card-stats">
                            <span class="stat-item">ğŸ“š {{ course.topics|length }} ä¸ªçŸ¥è¯†ç‚¹</span>
                            {% if course.materials %}
                            <span class="stat-item">ğŸ“„ {{ course.materials|length }} ä¸ªèµ„æ–™</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="course-card-footer">
                    <span class="view-details">ç‚¹å‡»æŸ¥çœ‹è¯¦æƒ… â†’</span>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<!-- è¯¾ç¨‹è¯¦æƒ…æ¨¡æ€æ¡† -->
<div id="courseModal" class="modal" onclick="closeCourseModal(event)">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-header">
            <h2 id="modalTitle"></h2>
            <span class="close" onclick="closeCourseModal()">&times;</span>
        </div>
        <div class="modal-body" id="modalBody">
            <!-- è¯¦ç»†å†…å®¹å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
        </div>
    </div>
</div>

<!-- éšè—çš„è¯¦ç»†å†…å®¹æ¨¡æ¿ -->
<div style="display: none;">
    {% for course in courses %}
    <div id="course-detail-{{ course.id }}">
        <div class="course-content">
            <div class="course-overview">
                <h3>è¯¾ç¨‹æ¦‚è¿°</h3>
                <p>{{ course.content }}</p>
            </div>
            
            <div class="course-topics">
                <h3>ä¸»è¦å†…å®¹</h3>
                <ul class="topics-list">
                    {% for topic in course.topics %}
                    <li>{{ topic }}</li>
                    {% endfor %}
                </ul>
            </div>
            
            {% if course.key_concepts %}
            <div class="course-concepts">
                <h3>æ ¸å¿ƒæ¦‚å¿µ</h3>
                <div class="concepts-list">
                    {% for concept in course.key_concepts %}
                    <div class="concept-item">
                        <h4>{{ concept.term }}</h4>
                        <p>{{ concept.definition }}</p>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if course.historical_figures %}
            <div class="course-history">
                <h3>é‡è¦å†å²äººç‰©</h3>
                <ul class="history-list">
                    {% for figure in course.historical_figures %}
                    <li>{{ figure }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            {% if course.statistical_methods %}
            <div class="course-methods">
                <h3>ç»Ÿè®¡æ–¹æ³•</h3>
                <ul class="methods-list">
                    {% for method in course.statistical_methods %}
                    <li>{{ method }}</li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
            
            {% if course.materials %}
            <div class="course-materials">
                <h3>è¯¾ç¨‹èµ„æ–™</h3>
                <div class="materials-list">
                    {% for material in course.materials %}
                    <div class="material-item">
                        <div class="material-icon">
                            {% if material.type == 'pdf' %}ğŸ“„{% endif %}
                        </div>
                        <div class="material-info">
                            <h4>{{ material.name }}</h4>
                            <p>{{ material.description }}</p>
                        </div>
                        <div class="material-actions">
                            <a href="{{ material.url }}" target="_blank" class="btn-primary">æŸ¥çœ‹</a>
                            <a href="{{ material.url }}" download class="btn-secondary">ä¸‹è½½</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            <div class="course-materials">
                <h3>è¯¾ç¨‹èµ„æ–™</h3>
                <p class="no-materials">è¯¾ç¨‹èµ„æ–™å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…...</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>

<script>
// è¯¾ç¨‹æ•°æ®
const courseData = {
    {% for course in courses %}
    {{ course.id }}: {
        title: "ç¬¬{{ course.id }}ç«  {{ course.title }}",
        content: `{{ course.content|escapejs }}`,
        topics: [{% for topic in course.topics %}"{{ topic|escapejs }}"{% if not forloop.last %},{% endif %}{% endfor %}],
        {% if course.key_concepts %}
        concepts: [
            {% for concept in course.key_concepts %}
            {term: "{{ concept.term|escapejs }}", definition: "{{ concept.definition|escapejs }}"}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ],
        {% endif %}
        {% if course.materials %}
        materials: [
            {% for material in course.materials %}
            {name: "{{ material.name|escapejs }}", url: "{{ material.url }}", description: "{{ material.description|escapejs }}"}{% if not forloop.last %},{% endif %}
            {% endfor %}
        ]
        {% endif %}
    }{% if not forloop.last %},{% endif %}
    {% endfor %}
};

function openCourseModal(courseId) {
    const modal = document.getElementById('courseModal');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    
    const course = courseData[courseId];
    if (!course) {
        console.error('Course not found:', courseId);
        return;
    }
    
    modalTitle.textContent = course.title;
    
    let content = '<div class="modal-content-wrapper">' +
        // è¯¾ç¨‹æ¦‚è¿° - å…¨å®½
        '<div class="course-overview modal-content-full">' +
        '<h3>è¯¾ç¨‹æ¦‚è¿°</h3>' +
        '<p>' + course.content + '</p>' +
        '</div>' +
        
        // ä¸»è¦å†…å®¹å’Œæ ¸å¿ƒæ¦‚å¿µ - ä¸¤åˆ—å¸ƒå±€
        '<div class="modal-content-grid">' +
        '<div class="course-topics">' +
        '<h3>ä¸»è¦å†…å®¹</h3>' +
        '<ul class="topics-list">' +
        course.topics.map(function(topic) { return '<li>' + topic + '</li>'; }).join('') +
        '</ul>' +
        '</div>';
    
    if (course.concepts) {
        content += '<div class="course-concepts">' +
            '<h3>æ ¸å¿ƒæ¦‚å¿µ</h3>' +
            '<div class="concepts-list">' +
            course.concepts.map(function(concept) {
                return '<div class="concept-item">' +
                    '<h4>' + concept.term + '</h4>' +
                    '<p>' + concept.definition + '</p>' +
                    '</div>';
            }).join('') +
            '</div>' +
            '</div>';
    } else {
        content += '<div class="course-concepts">' +
            '<h3>æ ¸å¿ƒæ¦‚å¿µ</h3>' +
            '<p class="no-concepts">æœ¬ç« èŠ‚æš‚æ— æ ¸å¿ƒæ¦‚å¿µæ•´ç†</p>' +
            '</div>';
    }
    
    content += '</div>'; // ç»“æŸ modal-content-grid
    
    // è¯¾ç¨‹èµ„æ–™ - å…¨å®½
    if (course.materials) {
        content += '<div class="course-materials modal-content-full">' +
            '<h3>è¯¾ç¨‹èµ„æ–™</h3>' +
            '<div class="materials-list">' +
            course.materials.map(function(material) {
                return '<div class="material-item">' +
                    '<div class="material-icon">PDF</div>' +
                    '<div class="material-info">' +
                    '<h4>' + material.name + '</h4>' +
                    '<p>' + material.description + '</p>' +
                    '</div>' +
                    '<div class="material-actions">' +
                    '<a href="' + material.url + '" target="_blank" class="btn-primary">æŸ¥çœ‹</a>' +
                    '<a href="' + material.url + '" download class="btn-secondary">ä¸‹è½½</a>' +
                    '</div>' +
                    '</div>';
            }).join('') +
            '</div>' +
            '</div>';
    } else {
        content += '<div class="course-materials modal-content-full">' +
            '<h3>è¯¾ç¨‹èµ„æ–™</h3>' +
            '<p class="no-materials">è¯¾ç¨‹èµ„æ–™å³å°†ä¸Šçº¿ï¼Œæ•¬è¯·æœŸå¾…...</p>' +
            '</div>';
    }
    
    content += '</div>'; // ç»“æŸ modal-content-wrapper
    
    modalBody.innerHTML = content;
    
    // ä½¿ç”¨CSSç±»æ¥æ§åˆ¶æ˜¾ç¤º
    modal.classList.add('show');
    document.body.style.overflow = 'hidden';
}

function closeCourseModal(event) {
    if (!event || event.target.id === 'courseModal' || event.target.className === 'close') {
        const modal = document.getElementById('courseModal');
        modal.classList.remove('show');
        document.body.style.overflow = 'auto';
    }
}
</script>
{% endblock %}