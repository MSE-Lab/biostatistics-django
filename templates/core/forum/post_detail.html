{% extends 'base.html' %}
{% load static %}
{% load chinese_name %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="post-detail-container">
    <!-- é¢åŒ…å±‘å¯¼èˆª -->
    <nav class="breadcrumb" style="margin-bottom: 32px;">
        <a href="{% url 'core:forum_index' %}">è®¨è®ºåŒº</a> > 
        <a href="{% url 'core:forum_category' post.category.id %}">{{ post.category.name }}</a> > 
        {{ post.title }}
    </nav>

    <!-- å¸–å­å¤´éƒ¨ä¿¡æ¯ -->
    <div class="post-detail-header">
        <div class="post-type-badge post-type-{{ post.post_type }}" style="margin-bottom: 20px;">
            {% if post.post_type == 'question' %}â“
            {% elif post.post_type == 'announcement' %}ğŸ“¢
            {% else %}ğŸ’¬{% endif %}
        </div>
        
        <h1 class="post-detail-title">
            {% if post.is_pinned %}ğŸ“Œ {% endif %}
            {% if post.is_locked %}ğŸ”’ {% endif %}
            {{ post.title }}
        </h1>
        
        <div class="post-detail-meta">
            <div class="post-author-info">
                <div class="author-avatar">
                    {{ post.author.real_name|first }}
                </div>
                <div class="author-details">
                    <div class="author-name">{{ post.author|chinese_full_name }}</div>
                    <div class="post-time">{{ post.created_at|date:"Yå¹´mæœˆdæ—¥ H:i" }}</div>
                </div>
            </div>
            
            <div class="post-detail-stats">
                <span>ğŸ‘ï¸ {{ post.view_count }} æµè§ˆ</span>
                <span>ğŸ’¬ {{ post.reply_count }} å›å¤</span>
                <span>ğŸ“‚ {{ post.category.name }}</span>
                {% if post.visibility != 'public' %}
                <span class="visibility-badge visibility-{{ post.visibility }}">
                    {% if post.visibility == 'class_only' %}
                        ğŸ« æ•™å­¦ç­å†…å¯è§
                    {% elif post.visibility == 'teacher_only' %}
                        ğŸ‘¨â€ğŸ« ç§ä¿¡æ•™å¸ˆ
                    {% endif %}
                </span>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- å¸–å­å†…å®¹ -->
    <div class="post-detail-content">
        {{ post.content|linebreaks }}
    </div>

    <!-- å›å¤åŒºåŸŸ -->
    <div class="replies-section">
        <div class="replies-header">
            <h2 class="replies-title">å›å¤ ({{ replies.count }})</h2>
            <div class="replies-count">å…± {{ replies.count }} æ¡å›å¤</div>
        </div>

        <!-- å›å¤åˆ—è¡¨ -->
        <div class="replies-list">
            {% for reply in replies %}
            <div class="reply-item">
                <div class="reply-header">
                    <div class="author-avatar" style="width: 32px; height: 32px; font-size: 0.9rem;">
                        {{ reply.author.real_name|first }}
                    </div>
                    <div class="reply-author">{{ reply.author|chinese_full_name }}</div>
                    <div class="reply-time">{{ reply.created_at|date:"mæœˆdæ—¥ H:i" }}</div>
                    {% if reply.is_best_answer %}
                    <span class="best-answer-badge" style="background: #34c759; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500;">âœ“ æœ€ä½³ç­”æ¡ˆ</span>
                    {% endif %}
                </div>
                
                <div class="reply-content">
                    {{ reply.content|linebreaks }}
                </div>
                
                <div class="reply-actions">
                    <button class="reply-action-btn" type="button">
                        ğŸ‘ {{ reply.like_count }}
                    </button>
                    {% if user.is_authenticated %}
                    <button class="reply-action-btn" type="button" onclick="showReplyForm({{ reply.id }})">
                        ğŸ’¬ å›å¤
                    </button>
                    {% endif %}
                    {% if user == post.author and post.post_type == 'question' and not reply.is_best_answer %}
                    <button class="reply-action-btn" type="button" style="color: #34c759;">
                        âœ“ è®¾ä¸ºæœ€ä½³ç­”æ¡ˆ
                    </button>
                    {% endif %}
                </div>
            </div>
            {% empty %}
            <div class="no-replies">
                <p>æš‚æ— å›å¤ï¼Œæ¥å‘è¡¨ç¬¬ä¸€ä¸ªå›å¤å§ï¼</p>
            </div>
            {% endfor %}
        </div>

        <!-- å›å¤è¡¨å• -->
        {% if user.is_authenticated and not post.is_locked and can_reply %}
        <div class="reply-form">
            <h3>å‘è¡¨å›å¤</h3>
            <form method="post" action="{% url 'core:forum_reply' post.id %}">
                {% csrf_token %}
                <div class="form-group">
                    <label for="content">å›å¤å†…å®¹</label>
                    <textarea name="content" id="content" class="form-control" 
                              rows="6" placeholder="è¯·è¾“å…¥æ‚¨çš„å›å¤å†…å®¹..." required></textarea>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">å‘è¡¨å›å¤</button>
                </div>
            </form>
        </div>
        {% elif not user.is_authenticated %}
        <div class="reply-form">
            <div style="text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 12px; color: #86868b;">
                <p>è¯· <a href="{% url 'core:login' %}" style="color: #007aff;">ç™»å½•</a> åå‚ä¸è®¨è®º</p>
            </div>
        </div>
        {% elif post.is_locked %}
        <div class="reply-form">
            <div style="text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 12px; color: #86868b;">
                <p>ğŸ”’ è¯¥å¸–å­å·²è¢«é”å®šï¼Œæ— æ³•å›å¤</p>
            </div>
        </div>
        {% elif not can_reply %}
        <div class="reply-form">
            <div style="text-align: center; padding: 40px 20px; background: #f8f9fa; border-radius: 12px; color: #86868b;">
                <p>ğŸš« æ‚¨æ²¡æœ‰æƒé™å›å¤æ­¤å¸–å­</p>
                {% if post.visibility == 'class_only' %}
                <small>æ­¤å¸–å­ä»…é™æ•™å­¦ç­å†…æˆå‘˜å›å¤</small>
                {% elif post.visibility == 'teacher_only' %}
                <small>æ­¤ä¸ºç§ä¿¡å¸–å­ï¼Œä»…é™ä»»è¯¾æ•™å¸ˆå›å¤</small>
                {% endif %}
            </div>
        </div>
        {% endif %}
    </div>
</div>

<script>
function showReplyForm(replyId) {
    // è¿™é‡Œå¯ä»¥æ·»åŠ å›å¤ç‰¹å®šå›å¤çš„åŠŸèƒ½
    document.getElementById('content').focus();
    document.getElementById('content').placeholder = 'å›å¤ #' + replyId + '...';
}
</script>
{% endblock %}